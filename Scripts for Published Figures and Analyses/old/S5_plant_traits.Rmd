---
title: "S5_plant_traits"
author: "Stephen Formel"
date: "3/28/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## load libraries + set color
```{r}
library(readxl)
library(plyr)
library(dplyr)
library(brms)
library(ggplot2)
library(tidybayes)
library(modelr)
library(glmmTMB)

```

#Aesthetics

```{r}

#color palette
cPAL <- c("#E69F00", "#0072B2")
```

## import data
```{r}
morph <- read_excel("../../data/S5_final_data_4Mar2020.xlsx", 
                 sheet = "plant_morphology", na = "NA")

sample_key <- read_excel("../../data/S5_final_data_4Mar2020.xlsx", 
                                     sheet = "sample_key", na = "NA")

df <- right_join(x = sample_key, y = morph, by = 'sampleID_stem')

#fix factors
df <- df %>%
  mutate_if(is.character, as.factor)

df$plantID <- as.factor(df$plantID)

df$sampling_period <- factor(df$sampling_period, levels = c("N16", "J17", "N17", "J18")) %>% 
  droplevels()

#Gussy up the factor levels
df$oil_added <- revalue(df$oil_added, c("Y" = "Oil Added", "N" = "No Oil Added"))
df$orig_soil <- revalue(df$orig_soil, c("Y" = "Prev-Oiled Inoc.", "N" = "Not Prev-Oiled Inoc"))

df$num_stems_live <- as.integer(df$num_stems_live)
df$num_nodes <- as.integer(df$num_nodes)

df <- df %>% 
  filter(sampling_period!="M16")
```

## plot

Number of nodes
```{r}

ggplot(df,
       aes(x = unclass(sampling_period),
           y = num_nodes,
           fill = orig_soil,
           shape = oil_added)) +
  geom_point(size = 2,
             alpha = 0.5,
             position = position_dodge(width = 0.4)) +
  theme_bw() +
  labs(y = "Mean Nodes per Stem",
       x = "Time",
       fill = "Inoculum",
       shape = "Oil Addition") +
  theme(legend.position = "right") +
  guides(fill = guide_legend(override.aes=list(shape=21)),
         color = guide_legend(override.aes=list(shape=21)),
         shape = guide_legend(override.aes=list(size = 4))) +
  scale_fill_manual(values = cPAL) +
  scale_shape_manual(values = c(21,24)) +
  scale_color_manual(values = cPAL)

ggsave("S5_stem_node_over_time.png", width = 8, height = 5.5)

```

## Stats

```{r}

m <- glm(num_nodes ~ orig_soil*oil_added, 
         data = df,
         family = poisson)

summary(m) 

#overdispersed because Residual deviance > degrees of freedom, although it's not terrible. 

m <- brm(num_nodes ~ 1 + (1|plantID) + unclass(sampling_period) + orig_soil*oil_added, 
         data = df,
         family = "negbinomial",
         control = list(adapt_delta = 0.85, 
                        max_treedepth = 10),
         cores = 4)

summary(m)

pp_check(object = m, type = "dens_overlay", nsamples = 100)
pp_check(m, type = "stat", stat = 'median', nsamples = 100)
pp_check(m, type = "stat", stat = 'mean', nsamples = 100)
pp_check(m ,type = 'intervals', nsamples = 100)

conditional_effects(m)

```


It's clear I did a bad job communicating how to count nodes.  Can't use this data.  Also clear that there isn't that big of a difference within any time point.


Stem Height
```{r}

ggplot(df,
       aes(x = unclass(sampling_period),
           y = stem_ht,
           fill = orig_soil,
           shape = oil_added)) +
  geom_point(size = 2,
             alpha = 0.5,
             position = position_dodge(width = 0.4)) +
  theme_bw() +
  labs(y = "Mean Stem Height (cm)",
       x = "Time",
       fill = "Inoculum",
       shape = "Oil Addition") +
  theme(legend.position = "right") +
  guides(fill = guide_legend(override.aes=list(shape=21)),
         color = guide_legend(override.aes=list(shape=21)),
         shape = guide_legend(override.aes=list(size = 4))) +
  scale_fill_manual(values = cPAL) +
  scale_shape_manual(values = c(21,24)) +
  scale_color_manual(values = cPAL)

ggsave("S5_stem_ht_over_time.png", width = 8, height = 5.5)

```

## Model

```{r}

m <- brm(stem_ht ~ 1 + (1|plantID) + unclass(sampling_period) + orig_soil*oil_added, 
         data = df,
         family = "skew_normal",
         control = list(adapt_delta = 0.99, 
                        max_treedepth = 10),
         cores = 4)

summary(m)

pp_check(object = m, type = "dens_overlay", nsamples = 100)
pp_check(m, type = "stat", stat = 'median', nsamples = 100)
pp_check(m, type = "stat", stat = 'mean', nsamples = 100)
pp_check(m ,type = 'intervals', nsamples = 100)

conditional_effects(m)
```

Periods 1 + 3 (November) are taller than 2 + 4, so that makes sense.  It doesn't look like there is anything worth pursuing here.  Stems may have gotten shorter over time, but it doesn't look like it's unique to any treatment.

Stem Diameter
```{r}

ggplot(df,
       aes(x = unclass(sampling_period),
           y = stem_diam,
           fill = orig_soil,
           shape = oil_added)) +
  geom_point(size = 2,
             alpha = 0.5,
             position = position_dodge(width = 0.4)) +
  theme_bw() +
  labs(y = "Mean Stem Height (mm)",
       x = "Time",
       fill = "Inoculum",
       shape = "Oil Addition") +
  theme(legend.position = "right") +
  guides(fill = guide_legend(override.aes=list(shape=21)),
         color = guide_legend(override.aes=list(shape=21)),
         shape = guide_legend(override.aes=list(size = 4))) +
  scale_fill_manual(values = cPAL) +
  scale_shape_manual(values = c(21,24)) +
  scale_color_manual(values = cPAL)

ggsave("S5_stem_diam_over_time.png", width = 8, height = 5.5)

```
## Model

```{r}

m <- brm(stem_diam ~ 1 + (1|plantID) + unclass(sampling_period) + orig_soil*oil_added, 
         data = df,
         family = "skew_normal",
         control = list(adapt_delta = 0.99, 
                        max_treedepth = 10),
         cores = 4)

summary(m)

pp_check(object = m, type = "dens_overlay", nsamples = 100)
pp_check(m, type = "stat", stat = 'median', nsamples = 100)
pp_check(m, type = "stat", stat = 'mean', nsamples = 100)
pp_check(m ,type = 'intervals', nsamples = 100)

conditional_effects(m)
```

Like height, it doesn't look like there is any effect of the treatments.  Diameters may get slightly smaller in J18, but that could also be a function of who was measuring them (if they squeezed the stems, or measured height poorly).  Still I'll plot the means of this one to see if there is a difference that corresponds to the growth chamber.

## plot stem diam means

```{r}

df %>%
  group_by(sampling_period, oil_added, orig_soil) %>% 
  summarise_at("stem_diam",
               funs(mean,
                     sd, 
                     se=sd(.)/sqrt(n()))) %>% 
  ggplot(aes(x = sampling_period,
           y = mean,
           fill = oil_added,
           shape = orig_soil))  +
  geom_point(size = 4,
             alpha = 0.5,
             position = position_dodge(width = 0.4)) +
  geom_errorbar(aes(min = mean - 2*se,
                    max = mean + 2*se),
                width = 0.2,
                position = position_dodge(width = 0.4)) +
  labs(y = "Mean Stem Diameter (mm)",
       x = NULL,
       fill = "Oil Addition", 
       caption = "Error bars represent \U00B1 2 SE") +
  scale_fill_manual(values = c("white", "black")) +
  scale_shape_manual(values = c(21,24)) +
  theme_bw()  +
  theme(legend.position = "right") +
  guides(fill=guide_legend(override.aes=list(shape=21)))
  
ggsave("S5_stem_diam_mean_over_time.png", width = 8, height = 5.5)

```

## Model

```{r}

m <- brm(num_stems_live ~ 1 + (1|plantID) + sampling_period*orig_soil*oil_added, 
         data = df,
         family = "negbinomial",
         control = list(adapt_delta = 0.99, 
                        max_treedepth = 10),
         cores = 4)

summary(m)

pp_check(object = m, type = "dens_overlay", nsamples = 100)
pp_check(m, type = "stat", stat = 'median', nsamples = 100)
pp_check(m, type = "stat", stat = 'mean', nsamples = 100)
pp_check(m ,type = 'intervals', nsamples = 100)

conditional_effects(m)
```
